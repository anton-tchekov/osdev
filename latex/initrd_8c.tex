\hypertarget{initrd_8c}{}\doxysection{platform/avr/initrd/initrd.c File Reference}
\label{initrd_8c}\index{platform/avr/initrd/initrd.c@{platform/avr/initrd/initrd.c}}
{\ttfamily \#include $<$atfs.\+h$>$}\newline
{\ttfamily \#include $<$initrd.\+h$>$}\newline
{\ttfamily \#include $<$types.\+h$>$}\newline
{\ttfamily \#include $<$sd.\+h$>$}\newline
{\ttfamily \#include $<$xmem.\+h$>$}\newline
{\ttfamily \#include $<$logger.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$avr/pgmspace.\+h$>$}\newline
\doxysubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{initrd_8c_a854d66354e57fbc7b45c65e237df294b}{RAM\+\_\+\+OFFSET\+\_\+\+STDLIB}}~0
\item 
\#define \mbox{\hyperlink{initrd_8c_a72d6978f37680a47e2e79a4dab6e6259}{RAM\+\_\+\+OFFSET\+\_\+\+INIT}}~0
\end{DoxyCompactItemize}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{initrd_8c_afb664c3988d855629cd7b611cf610561}{initrd\+\_\+load}} (void)
\begin{DoxyCompactList}\small\item\em Load the INIT program and Standard Shared Library from special area on disk. The full featured filesystem driver is in userspace. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\begin{DoxyAuthor}{Author}
Anton Tchekov 
\end{DoxyAuthor}
\begin{DoxyVersion}{Version}
0.\+1 
\end{DoxyVersion}
\begin{DoxyDate}{Date}
21.\+05.\+2023 
\end{DoxyDate}


Definition in file \mbox{\hyperlink{initrd_8c_source}{initrd.\+c}}.



\doxysubsection{Macro Definition Documentation}
\mbox{\Hypertarget{initrd_8c_a72d6978f37680a47e2e79a4dab6e6259}\label{initrd_8c_a72d6978f37680a47e2e79a4dab6e6259}} 
\index{initrd.c@{initrd.c}!RAM\_OFFSET\_INIT@{RAM\_OFFSET\_INIT}}
\index{RAM\_OFFSET\_INIT@{RAM\_OFFSET\_INIT}!initrd.c@{initrd.c}}
\doxysubsubsection{\texorpdfstring{RAM\_OFFSET\_INIT}{RAM\_OFFSET\_INIT}}
{\footnotesize\ttfamily \#define RAM\+\_\+\+OFFSET\+\_\+\+INIT~0}

RAM Offset of INIT Program 

Definition at line \mbox{\hyperlink{initrd_8c_source_l00023}{23}} of file \mbox{\hyperlink{initrd_8c_source}{initrd.\+c}}.

\mbox{\Hypertarget{initrd_8c_a854d66354e57fbc7b45c65e237df294b}\label{initrd_8c_a854d66354e57fbc7b45c65e237df294b}} 
\index{initrd.c@{initrd.c}!RAM\_OFFSET\_STDLIB@{RAM\_OFFSET\_STDLIB}}
\index{RAM\_OFFSET\_STDLIB@{RAM\_OFFSET\_STDLIB}!initrd.c@{initrd.c}}
\doxysubsubsection{\texorpdfstring{RAM\_OFFSET\_STDLIB}{RAM\_OFFSET\_STDLIB}}
{\footnotesize\ttfamily \#define RAM\+\_\+\+OFFSET\+\_\+\+STDLIB~0}

RAM Offset of STDLIB 

Definition at line \mbox{\hyperlink{initrd_8c_source_l00020}{20}} of file \mbox{\hyperlink{initrd_8c_source}{initrd.\+c}}.



\doxysubsection{Function Documentation}
\mbox{\Hypertarget{initrd_8c_afb664c3988d855629cd7b611cf610561}\label{initrd_8c_afb664c3988d855629cd7b611cf610561}} 
\index{initrd.c@{initrd.c}!initrd\_load@{initrd\_load}}
\index{initrd\_load@{initrd\_load}!initrd.c@{initrd.c}}
\doxysubsubsection{\texorpdfstring{initrd\_load()}{initrd\_load()}}
{\footnotesize\ttfamily void initrd\+\_\+load (\begin{DoxyParamCaption}\item[{void}]{ }\end{DoxyParamCaption})}



Load the INIT program and Standard Shared Library from special area on disk. The full featured filesystem driver is in userspace. 



Definition at line \mbox{\hyperlink{initrd_8c_source_l00025}{25}} of file \mbox{\hyperlink{initrd_8c_source}{initrd.\+c}}.


\begin{DoxyCode}{0}
\DoxyCodeLine{00026\ \{}
\DoxyCodeLine{00027\ \ \ \ \ \mbox{\hyperlink{types_8h_a92c50087ca0e64fa93fc59402c55f8ca}{u8}}\ buf[\mbox{\hyperlink{apps_2tetris_2main_8c_ad51ded0bbd705f02f73fc60c0b721ced}{BLOCK\_SIZE}}];}
\DoxyCodeLine{00028\ \ \ \ \ \mbox{\hyperlink{types_8h_ace9d960e74685e2cd84b36132dbbf8aa}{u16}}\ block,\ num\_sectors;}
\DoxyCodeLine{00029\ \ \ \ \ \mbox{\hyperlink{types_8h_afaa62991928fb9fb18ff0db62a040aba}{u32}}\ addr,\ revision,\ size\_stdlib,\ size\_init;}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \ \ \mbox{\hyperlink{logger_8c_a60bd636ef160c97eb51cf31be5954ba2}{log\_boot\_P}}(LOG\_INIT,\ PSTR(\textcolor{stringliteral}{"{}Loading\ Init\ Binary"{}}));}
\DoxyCodeLine{00032\ \ \ \ \ \mbox{\hyperlink{sd_8c_a3f0c63e822010bb899b9e13d73a685dd}{sd\_read}}(\mbox{\hyperlink{atfs_8h_abef1527b5f0917d3ca73ac7a60435ae3}{ATFS\_SECTOR\_BOOT}},\ buf);}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \ \ \ \ \textcolor{comment}{/*\ Check\ signature\ */}}
\DoxyCodeLine{00035\ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{string_8c_a8abe583def8cefd53678bec4126eeefe}{memcmp}}(buf\ +\ \mbox{\hyperlink{atfs_8h_a2ea0d3fde1f46a1b5b3d1ab55b7e3d5b}{ATFS\_OFFSET\_SIGNATURE}},\ \mbox{\hyperlink{atfs_8h_adf3e5683d8b4681edf588f58e4a02494}{\_atfs\_signature}},\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{atfs_8h_adf3e5683d8b4681edf588f58e4a02494}{\_atfs\_signature}})))}
\DoxyCodeLine{00036\ \ \ \ \ \{}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8c_a19a313011d8f478ad9799e546199a9ac}{panic}}(PSTR(\textcolor{stringliteral}{"{}Wrong\ FS\ signature"{}}));}
\DoxyCodeLine{00038\ \ \ \ \ \}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{comment}{/*\ Check\ revision\ */}}
\DoxyCodeLine{00041\ \ \ \ \ revision\ =\ \mbox{\hyperlink{atfs_8h_a58dff0b38327e2389ba33ca793d2b633}{load\_le\_32}}(buf\ +\ \mbox{\hyperlink{atfs_8h_afa4c7c978e0253bb3c3e2b6828b49afd}{ATFS\_OFFSET\_REVISION}});}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keywordflow}{if}(revision\ !=\ \mbox{\hyperlink{atfs_8h_a57c1cdf2546cad6e7458aa3f4b19f527}{ATFS\_REVISION}})}
\DoxyCodeLine{00043\ \ \ \ \ \{}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8c_a19a313011d8f478ad9799e546199a9ac}{panic}}(PSTR(\textcolor{stringliteral}{"{}Unsupported\ ATFS\ revision"{}}));}
\DoxyCodeLine{00045\ \ \ \ \ \}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{comment}{/*\ Get\ STDLIB\ Size\ */}}
\DoxyCodeLine{00048\ \ \ \ \ size\_stdlib\ =\ \mbox{\hyperlink{atfs_8h_a58dff0b38327e2389ba33ca793d2b633}{load\_le\_32}}(buf\ +\ \mbox{\hyperlink{atfs_8h_aa51051aec9ee36f50493079fc1e2ec7d}{ATFS\_OFFSET\_STDLIB\_SIZE}});}
\DoxyCodeLine{00049\ }
\DoxyCodeLine{00050\ \ \ \ \ \textcolor{comment}{/*\ Get\ INIT\ Size\ */}}
\DoxyCodeLine{00051\ \ \ \ \ size\_init\ =\ \mbox{\hyperlink{atfs_8h_a58dff0b38327e2389ba33ca793d2b633}{load\_le\_32}}(buf\ +\ \mbox{\hyperlink{atfs_8h_ac61a5c871bbbb33f1f12c644bb7b105a}{ATFS\_OFFSET\_INIT\_SIZE}});}
\DoxyCodeLine{00052\ }
\DoxyCodeLine{00053\ \ \ \ \ \textcolor{comment}{/*\ Load\ STDLIB\ */}}
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{comment}{/*\ \_load\_xmem(RAM\_OFFSET\_STDLIB,\ SECTOR\_STDLIB,\ size\_stdlib\ >>\ BLOCK\_SIZE\_POT);\ */}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \ \ \mbox{\hyperlink{logger_8c_a60bd636ef160c97eb51cf31be5954ba2}{log\_boot\_P}}(LOG\_EXT,\ PSTR(\textcolor{stringliteral}{"{}INIT\ Size:\ \%"{}}PRIu32),\ size\_init);}
\DoxyCodeLine{00057\ \ \ \ \ \mbox{\hyperlink{logger_8c_a60bd636ef160c97eb51cf31be5954ba2}{log\_boot\_P}}(LOG\_EXT,\ PSTR(\textcolor{stringliteral}{"{}STDLIB\ Size:\ \%"{}}PRIu32),\ size\_stdlib);}
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00059\ \ \ \ \ num\_sectors\ =\ (size\_init\ +\ \mbox{\hyperlink{apps_2tetris_2main_8c_ad51ded0bbd705f02f73fc60c0b721ced}{BLOCK\_SIZE}}\ -\/\ 1)\ >>\ \mbox{\hyperlink{sd_8h_a456e1098b18ecd0666395e17ef9b6ca8}{BLOCK\_SIZE\_POT}};}
\DoxyCodeLine{00060\ \ \ \ \ \mbox{\hyperlink{logger_8c_a60bd636ef160c97eb51cf31be5954ba2}{log\_boot\_P}}(LOG\_EXT,\ PSTR(\textcolor{stringliteral}{"{}INIT\ Sectors:\ \%d"{}}),\ num\_sectors);}
\DoxyCodeLine{00061\ }
\DoxyCodeLine{00062\ \ \ \ \ \textcolor{comment}{/*\ Load\ INIT\ */}}
\DoxyCodeLine{00063\ \ \ \ \ \textcolor{keywordflow}{for}(addr\ =\ 0,\ block\ =\ \mbox{\hyperlink{atfs_8h_a34195cda27663494d697f1d5a14f0213}{ATFS\_SECTOR\_INIT}};}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ block\ <\ \mbox{\hyperlink{atfs_8h_a34195cda27663494d697f1d5a14f0213}{ATFS\_SECTOR\_INIT}}\ +\ num\_sectors;}
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ ++block,\ addr\ +=\ \mbox{\hyperlink{apps_2tetris_2main_8c_ad51ded0bbd705f02f73fc60c0b721ced}{BLOCK\_SIZE}})}
\DoxyCodeLine{00066\ \ \ \ \ \{}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(\mbox{\hyperlink{sd_8c_a3f0c63e822010bb899b9e13d73a685dd}{sd\_read}}(block,\ buf))}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{logger_8c_a19a313011d8f478ad9799e546199a9ac}{panic}}(PSTR(\textcolor{stringliteral}{"{}Loading\ InitRD\ failed"{}}));}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00071\ }
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{xmem_8c_afef9c92490450d98f177f53f2b174f20}{xmem\_write}}(addr,\ buf,\ \mbox{\hyperlink{apps_2tetris_2main_8c_ad51ded0bbd705f02f73fc60c0b721ced}{BLOCK\_SIZE}});}
\DoxyCodeLine{00073\ \ \ \ \ \}}
\DoxyCodeLine{00074\ \}}

\end{DoxyCode}


References \mbox{\hyperlink{atfs_8h_source_l00059}{\+\_\+atfs\+\_\+signature}}, \mbox{\hyperlink{atfs_8h_source_l00056}{ATFS\+\_\+\+OFFSET\+\_\+\+INIT\+\_\+\+SIZE}}, \mbox{\hyperlink{atfs_8h_source_l00050}{ATFS\+\_\+\+OFFSET\+\_\+\+REVISION}}, \mbox{\hyperlink{atfs_8h_source_l00047}{ATFS\+\_\+\+OFFSET\+\_\+\+SIGNATURE}}, \mbox{\hyperlink{atfs_8h_source_l00053}{ATFS\+\_\+\+OFFSET\+\_\+\+STDLIB\+\_\+\+SIZE}}, \mbox{\hyperlink{atfs_8h_source_l00042}{ATFS\+\_\+\+REVISION}}, \mbox{\hyperlink{atfs_8h_source_l00021}{ATFS\+\_\+\+SECTOR\+\_\+\+BOOT}}, \mbox{\hyperlink{atfs_8h_source_l00033}{ATFS\+\_\+\+SECTOR\+\_\+\+INIT}}, \mbox{\hyperlink{apps_2tetris_2main_8c_source_l00022}{BLOCK\+\_\+\+SIZE}}, \mbox{\hyperlink{sd_8h_source_l00019}{BLOCK\+\_\+\+SIZE\+\_\+\+POT}}, \mbox{\hyperlink{atfs_8h_source_l00081}{load\+\_\+le\+\_\+32()}}, \mbox{\hyperlink{logger_8c_source_l00170}{log\+\_\+boot\+\_\+\+P()}}, \mbox{\hyperlink{string_8c_source_l00141}{memcmp()}}, \mbox{\hyperlink{logger_8c_source_l00183}{panic()}}, \mbox{\hyperlink{sd_8c_source_l00560}{sd\+\_\+read()}}, and \mbox{\hyperlink{xmem_8c_source_l00297}{xmem\+\_\+write()}}.



Referenced by \mbox{\hyperlink{platform_2avr_2main_8c_source_l00029}{main()}}.


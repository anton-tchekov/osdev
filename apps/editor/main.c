/**
 * @file    main.c
 * @author  Anton Tchekov
 * @version 0.1
 * @date    24.05.2023
 *
 * @brief   Text/Code Editor App
 */

#include <std.h>
#include <ubuntu_regular.h>
#include <keyboard.h>

#define INITIAL_CODE_CAPACITY 16
#define LINE_HEIGHT 12

static const char _file[] = {0x76, 0x6F, 0x69, 0x64, 0x20, 0x65, 0x64, 0x69, 0x74, 0x6F, 0x72, 0x5F, 0x62, 0x61, 0x63, 0x6B,
							 0x73, 0x70, 0x61, 0x63, 0x65, 0x28, 0x45, 0x64, 0x69, 0x74, 0x6F, 0x72, 0x20, 0x2A, 0x65, 0x64,
							 0x29, 0x0A, 0x7B, 0x0A, 0x09, 0x56, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x20, 0x2A, 0x6C, 0x69, 0x6E,
							 0x65, 0x20, 0x3D, 0x20, 0x76, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x5F, 0x67, 0x65, 0x74, 0x28, 0x26,
							 0x65, 0x64, 0x2D, 0x3E, 0x4C, 0x69, 0x6E, 0x65, 0x73, 0x2C, 0x20, 0x65, 0x64, 0x2D, 0x3E, 0x43,
							 0x75, 0x72, 0x73, 0x6F, 0x72, 0x59, 0x29, 0x3B, 0x0A, 0x09, 0x69, 0x66, 0x20, 0x28, 0x65, 0x64,
							 0x2D, 0x3E, 0x43, 0x75, 0x72, 0x73, 0x6F, 0x72, 0x58, 0x20, 0x3D, 0x3D, 0x20, 0x30, 0x29, 0x0A,
							 0x09, 0x7B, 0x0A, 0x09, 0x09, 0x69, 0x66, 0x20, 0x28, 0x65, 0x64, 0x2D, 0x3E, 0x43, 0x75, 0x72,
							 0x73, 0x6F, 0x72, 0x59, 0x20, 0x3E, 0x20, 0x30, 0x29, 0x0A, 0x09, 0x09, 0x7B, 0x0A, 0x09, 0x09,
							 0x09, 0x2F, 0x2A, 0x20, 0x6D, 0x65, 0x72, 0x67, 0x65, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x70,
							 0x72, 0x65, 0x76, 0x69, 0x6F, 0x75, 0x73, 0x20, 0x6C, 0x69, 0x6E, 0x65, 0x20, 0x2A, 0x2F, 0x0A,
							 0x09, 0x09, 0x09, 0x56, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x20, 0x2A, 0x70, 0x72, 0x65, 0x76, 0x20,
							 0x3D, 0x20, 0x76, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x5F, 0x67, 0x65, 0x74, 0x28, 0x26, 0x65, 0x64,
							 0x2D, 0x3E, 0x4C, 0x69, 0x6E, 0x65, 0x73, 0x2C, 0x20, 0x2D, 0x2D, 0x65, 0x64, 0x2D, 0x3E, 0x43,
							 0x75, 0x72, 0x73, 0x6F, 0x72, 0x59, 0x29, 0x3B, 0x0A, 0x09, 0x09, 0x09, 0x65, 0x64, 0x2D, 0x3E,
							 0x43, 0x75, 0x72, 0x73, 0x6F, 0x72, 0x58, 0x20, 0x3D, 0x20, 0x76, 0x65, 0x63, 0x74, 0x6F, 0x72,
							 0x5F, 0x6C, 0x65, 0x6E, 0x28, 0x70, 0x72, 0x65, 0x76, 0x29, 0x3B, 0x0A, 0x09, 0x09, 0x09, 0x76,
							 0x65, 0x63, 0x74, 0x6F, 0x72, 0x5F, 0x70, 0x75, 0x73, 0x68, 0x5F, 0x72, 0x61, 0x6E, 0x67, 0x65,
							 0x28, 0x70, 0x72, 0x65, 0x76, 0x2C, 0x20, 0x76, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x5F, 0x6C, 0x65,
							 0x6E, 0x28, 0x6C, 0x69, 0x6E, 0x65, 0x29, 0x2C, 0x20, 0x6C, 0x69, 0x6E, 0x65, 0x2D, 0x3E, 0x44,
							 0x61, 0x74, 0x61, 0x29, 0x3B, 0x0A, 0x09, 0x09, 0x09, 0x76, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x5F,
							 0x64, 0x65, 0x73, 0x74, 0x72, 0x6F, 0x79, 0x28, 0x6C, 0x69, 0x6E, 0x65, 0x29, 0x3B, 0x0A, 0x09,
							 0x09, 0x09, 0x76, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x5F, 0x72, 0x65, 0x6D, 0x6F, 0x76, 0x65, 0x28,
							 0x26, 0x65, 0x64, 0x2D, 0x3E, 0x4C, 0x69, 0x6E, 0x65, 0x73, 0x2C, 0x20, 0x65, 0x64, 0x2D, 0x3E,
							 0x43, 0x75, 0x72, 0x73, 0x6F, 0x72, 0x59, 0x20, 0x2B, 0x20, 0x31, 0x29, 0x3B, 0x0A, 0x09, 0x09,
							 0x7D, 0x0A, 0x09, 0x7D, 0x0A, 0x09, 0x65, 0x6C, 0x73, 0x65, 0x0A, 0x09, 0x7B, 0x0A, 0x09, 0x09,
							 0x2F, 0x2A, 0x20, 0x64, 0x65, 0x6C, 0x65, 0x74, 0x65, 0x20, 0x70, 0x72, 0x65, 0x76, 0x20, 0x63,
							 0x68, 0x61, 0x72, 0x20, 0x2A, 0x2F, 0x0A, 0x09, 0x09, 0x76, 0x65, 0x63, 0x74, 0x6F, 0x72, 0x5F,
							 0x72, 0x65, 0x6D, 0x6F, 0x76, 0x65, 0x28, 0x6C, 0x69, 0x6E, 0x65, 0x2C, 0x20, 0x2D, 0x2D, 0x65,
							 0x64, 0x2D, 0x3E, 0x43, 0x75, 0x72, 0x73, 0x6F, 0x72, 0x58, 0x29, 0x3B, 0x0A, 0x09, 0x7D, 0x0A,
							 0x7D};

typedef struct
{
	u32 ColorComment, ColorNumber, ColorString, ColorKeyword;
} SyntaxHighlighter;

static Vector _code;

static Window _window_editor;

void event_key(Key key, i32 chr, KeyState state)
{
}
static void _draw_line_numbers(i32 max_line)
{
	static i32 lines_count = 0;

	if (lines_count == max_line)
	{
		return;
	}

	if (lines_count > max_line)
	{
		/* remove line numbers */
		i32 start = max_line * LINE_HEIGHT + 20;
		gfx_rect(0, start, GFX_HEIGHT - start, 29, COLOR_BLACK);
	}
	else
	{
		char buf[16];
		/* add line numbers */
		for (i32 i = lines_count; i <= max_line; i++)
		{
			i32 posY = i * LINE_HEIGHT + 22;
			snprintf(buf, sizeof(buf), "%d", i);
			i32 b = font_string_width(buf, ubuntu_regular);
			font_string(25 - b, posY, buf, ubuntu_regular, COLOR_WHITE, COLOR_BLACK);
		}
	}
	lines_count = max_line;
}

static Color _get_bracket_color(i32 i)
{
	static Color _colors[] = {
		0xD4D4AAFF,
		0xD1A06EFF,
		0x742704FF};
	return _colors[i % ARRLEN(_colors)];
}

static void _draw_code()
{

	i32 line = 0;
	i32 col = 0;
	i32 len = vector_len(&_code);
	char *text = vector_data(&_code);

	bool inComment = false;
	bool inSingleString = false;
	bool inDoubleString = false;
	bool inKeyword = false;
	int keywordRemain = 0;
	int brackets = 0;

	for (i32 i = 0; i < len; i++)
	{
		Color color = COLOR_WHITE;
		char c = text[i];

		if (!inKeyword && !isalnum(text[i - 1]))
		{
			i32 j;
			/* Find end of word */
			for (j = i; j < len; ++j)
			{
				if (!isalnum(text[j]))
				{
					break;
				}
			}

			i32 word_len = j - i;
			if (keyword_detect(&text[i], word_len))
			{
				debug_print("Keyword detected: \"%*.s\" (len = %d)\n", word_len, &text[i], word_len);
				inKeyword = true;
				keywordRemain = word_len;
				color = COLOR_BLUE;
			}
		}

		if (c == '{')
		{
			color = _get_bracket_color(brackets);
			brackets++;
		}
		if (c == '}')
		{
			brackets--;
			color = _get_bracket_color(brackets);
		}

		if (isdigit(c))
		{
			color = COLOR_LIME;
		}

		if (inKeyword)
		{
			keywordRemain--;
			if (!keywordRemain)
			{
				inKeyword = false;
			}

			color = COLOR_BLUE;
		}

		if (c == '\'' && text[i - 1] != '\\' && !inDoubleString)
		{
			color = COLOR_ORANGE;
			inSingleString = !inSingleString;
		}

		if (c == '"' && text[i - 1] != '\\' && !inSingleString)
		{
			color = COLOR_ORANGE;
			inDoubleString = !inDoubleString;
		}

		if (c == '/' && text[i + 1] == '*')
		{
			color = COLOR_GREEN;
			inComment = true;
		}
		if (c == '/' && text[i - 1] == '*')
		{
			color = COLOR_GREEN;
			inComment = false;
		}

		if (inSingleString || inDoubleString)
		{
			color = COLOR_ORANGE;
		}
		if (inComment)
		{
			color = COLOR_GREEN;
		}

		if (c == '\n')
		{
			col = 0;
			line++;
		}
		else
		{
			i32 cLen = font_string_width_len(&c, 1, ubuntu_regular);
			i32 x = col * 8 + 33;
			i32 y = line * LINE_HEIGHT + 22;
			col++;
			if (x <= GFX_WIDTH - 10 && y <= GFX_HEIGHT - 10)
			{
				font_string_len(x, y, &c, 1, ubuntu_regular, color, COLOR_BLACK);
			}
		}
	}
}

void setup(void)
{
	keyboard_register_event(event_key);
	vector_init(&_code, sizeof(char), INITIAL_CODE_CAPACITY);
	keyword_init();

	char *s = "\"hello 'world' \"! \n'\"hihi\" sprach 12er' (anm.d.K.) \n123 int i = 5;\ni32 main(int argc, char *argv[])";
	vector_set(&_code, _file, ARRLEN(_file));

	window_init(&_window_editor, "Editor", NULL, 0, NULL);
	window_open(&_window_editor);
	gfx_rect(30, 20, 1, GFX_HEIGHT - 20, THEME_LIGHT);
	_draw_line_numbers(37);
	_draw_code();
}

void loop(void)
{
}
